<script lang="ts">
import Hls from "hls.js"
import { LoopModes, MusicPlayerData } from "./data/MusicPlayerData"
import emitter, { HLSPlayerEvents } from "../services/emitter"

export default {
  data () {
    return {
      playerData: MusicPlayerData,
      currentStreamUrl: undefined,
      hls: new Hls()
    }
  },
  watch: {
    "playerData.currentVolume": function (newVal, oldVal) {
      this.$refs.video.volume = newVal
    },
    "playerData.isPlaying": function (newVal, oldVal) {
      if (newVal) {
        this.$refs.video.play()
      } else {
        this.$refs.video.pause()
      }
    },
    "playerData.currentSong": function (newVal, oldVal) {
      this.loadAndPlay(newVal)
    },
    "playerData.currentQueueIndex": function (newVal, oldVal) {
      const newSong = this.playerData.queue[newVal]
      if (newSong) {
        this.$refs.video.currentTime = 0
        this.playerData.currentSong = newSong
      } else {
        this.playerData.currentQueueIndex = oldVal
        this.$refs.video.currentTime = 0
        this.pause()
      }
    }
  },
  mounted () {
    this.hls.attachMedia(this.$refs.video)
    this.$refs.video.volume = this.playerData.currentVolume
    // setup event bus events
    emitter.on(HLSPlayerEvents.seek_to_s, this.emitter_onSeekToS)
    // setup HTMLMediaElement events
    this.$refs.video.onloadedmetadata = this.metadataLoaded
    this.$refs.video.ontimeupdate = this.onPlayTimeUpdate
  },
  unmounted () {
    // unregister event bus events
    emitter.on(HLSPlayerEvents.seek_to_s, this.emitter_onSeekToS)
  },
  methods: {
    loadAndPlay (song) {
      const streamUrl = this.$backendBaseUrl + "/stream/" + song.sha1 + ".m3u8"
      if (streamUrl !== this.currentStreamUrl) {
        this.hls.loadSource(streamUrl)
      } else {
        this.$refs.video.currentTime = 0
      }
      this.play()
    },
    play () {
      this.$refs.video.play()
      this.playerData.isPlaying = true
    },
    pause () {
      this.$refs.video.pause()
      this.playerData.isPlaying = false
    },
    emitter_onSeekToS (seekS) {
      this.$refs.video.currentTime = seekS
      if (this.$refs.video.paused) {
        this.play()
      }
    },
    onPlayTimeUpdate () {
      this.playerData.currentSongPlaytime = this.$refs.video.currentTime
      if (this.playerData.currentSongPlaytime >= this.playerData.currentSong.duration) {
        this.onCurrentSongEnded()
      }
    },
    onCurrentSongEnded () {
      if (this.playerData.loopMode === LoopModes.LoopOne) {
        this.$refs.video.currentTime = 0
        this.play()
      } else if (this.playerData.loopMode === LoopModes.LoopQueue) {
        if (this.playerData.currentQueueIndex + 1 >= this.playerData.queue.length) {
          this.playerData.currentQueueIndex = 0
        } else {
          this.playerData.currentQueueIndex += 1
        }
      } else if (this.playerData.loopMode === LoopModes.None) {
        this.playerData.currentQueueIndex += 1
      }
    }
  }
}
</script>

<template>
  <video ref="video" class="hidden" />
</template>
